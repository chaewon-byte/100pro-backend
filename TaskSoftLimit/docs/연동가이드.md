# 연동 가이드 — 백엔드에서 TaskSoftLimit 사용

## 1. 역할 분리

- **TaskSoftLimit:** 과부하 판별, guide_exposed 기록 요청, 생성 허용 여부(항상 허용) 반환. **목표 저장·이벤트 영속화는 하지 않음.**
- **백엔드(Controller → Service → Repository):** ActiveTaskCount 조회, 목표 저장, GoalEventLog 저장, task_create/task_modify/app_close/task_complete 기록.

## 2. ActiveTaskCount 계산

백엔드에서 **당일·활성 목표 수**를 계산하여 전달.

- **조건:** `user_id = ? AND date = 오늘 AND status = 'active'` (또는 동일 의미)
- **시점:** 목표 **생성 요청 처리 시**, 생성 전에 조회.

## 3. 이벤트 로거 구현

`GoalEventLogger` 프로토콜을 구현하여 GoalEventLog 테이블(또는 로그 스토리지)에 저장.

```python
# 예: FastAPI + SQLAlchemy
class GoalEventLogRepository:
    def log(self, user_id, event_type, *, goal_id=None, payload=None, occurred_at=None):
        # GoalEventLog 엔티티 저장
        ...
```

목표 생성 API에서 이 인스턴스를 `execute_goal_create_flow(..., event_logger=...)`에 주입.

## 4. 목표 생성 API 흐름 (권장)

1. **ActiveTaskCount 조회** (당일·활성 목표 수)
2. **execute_goal_create_flow(user_id, active_task_count, event_logger)** 호출  
   → 과부하 시 내부에서 guide_exposed 기록, `GoalCreateFlowResult(guide_exposed=..., guide_message=...)` 반환 (가이드 노출 시 `guide_message`에 문구 포함)
3. **목표 생성** (DB 저장)
4. **task_create 이벤트 기록** (user_id, goal_id=생성된 목표 ID, event_type=TASK_CREATE)
5. **응답** 시 `guide_exposed` 값을 헤더 또는 본문 필드로 전달 (선택). UI/팝업은 프론트에서 처리.

## 5. 기타 이벤트

- **task_modify:** 목표 수정/삭제/교체 처리 시
- **app_close:** 앱(세션) 종료 시
- **task_complete:** 목표 완료 처리 시

위 이벤트는 각 API/처리 지점에서 동일한 `GoalEventLog` 저장소에 `event_type`과 payload를 넣어 기록하면 된다.
