# 설계서 — ActiveTaskCount 기반 Soft 제한 실험 인프라

## 1. 도메인 모델 설계

### 1.1 User

- **역할:** 목표(Goal)의 소유자, 이벤트 로그의 주체 식별
- **핵심 속성 (예시)**
  - `id`: PK
  - 식별용 필드 (외부 시스템과 연동 시 필요한 최소 정보)
- **비고:** 본 모듈에서는 "누가" 목표를 생성했는지 식별하기 위한 최소 엔티티. 상세 프로필은 사용자 도메인에서 관리.

### 1.2 Goal

- **역할:** 사용자가 설정한 단일 목표(할 일) 엔티티
- **핵심 속성 (예시)**
  - `id`: PK
  - `user_id`: FK → User (목표 소유자)
  - `title` (또는 `content`): 목표 내용
  - `status`: 활성/완료/삭제 등 (ActiveTaskCount는 **활성** 상태만 카운트)
  - `date` 또는 `target_date`: 목표가 속한 날짜 (당일 기준 계산 시 사용)
  - `created_at`, `updated_at`: 생성/수정 시각
- **ActiveTaskCount 계산:**  
  **당일(date = 오늘)** 이고 **status = 활성**인 Goal 개수로 계산.

### 1.3 GoalEventLog

- **역할:** 사용자/시스템 행동 추적 및 실험 분석을 위한 이벤트 로그
- **핵심 속성 (예시)**
  - `id`: PK
  - `user_id`: FK → User (이벤트 주체)
  - `event_type`: 이벤트 종류 (guide_exposed, task_create, task_modify, app_close, task_complete 등)
  - `goal_id`: FK → Goal (nullable, 이벤트가 특정 목표에 연결될 때)
  - `payload`: JSON 등 추가 컨텍스트 (active_task_count, threshold, 실험 그룹 등)
  - `occurred_at`: 이벤트 발생 시각
- **비고:** 이벤트 로그 중심 설계의 핵심. 분석 시 실험 단위(6번째 목표 생성 시도 첫 발생) 복원 가능하도록 보존.

---

## 2. 이벤트 로깅 구조

### 2.1 Soft 제한 실험에서 사용하는 이벤트

| event_type | 설명 | 기록 시점 | goal_id |
|------------|------|-----------|---------|
| **guide_exposed** | 가이드 노출(과부하 안내) | 목표 생성 요청 시 ActiveTaskCount ≥ 6일 때 | null 또는 생성 대상 목표(생성 후) |
| **task_create** | 목표 생성 | 목표 생성 완료 시 | 생성된 Goal.id |
| **task_modify** | 목표 수정/삭제/교체 | 수정·삭제·교체 요청 처리 시 | 대상 Goal.id |
| **app_close** | 앱 종료 | 클라이언트 또는 세션 종료 시점 | null |
| **task_complete** | 목표 완료 | 목표 완료 처리 시 | 완료된 Goal.id |

### 2.2 payload 예시 (guide_exposed)

- `active_task_count`: 계산된 활성 목표 수
- `guide_exposure_threshold`: 사용된 threshold (예: 6)
- (선택) `experiment_group`, `is_first_6th_attempt` 등 실험 메타

### 2.3 기록 원칙

- **목표 생성 흐름:** 계산 → 과부하 판별 → **guide_exposed 기록(조건 충족 시)** → **task_create 기록** → 생성 허용(응답).
- 다른 이벤트(task_modify, app_close, task_complete)는 각 행동 발생 시점에 서비스 레이어에서 기록.

---

## 3. ActiveTaskCount 계산 방식

- **정의:** 해당 사용자에 대해 **당일(target_date = 오늘)** 이고 **상태 = 활성(active)** 인 Goal의 개수.
- **수식:**  
  `ActiveTaskCount(user_id, date_today) = COUNT(Goal WHERE user_id = ? AND date = date_today AND status = 'active')`
- **조회 시점:** 목표 **생성 요청 시점** (생성 전에 현재 활성 개수를 센다).
- **비고:**  
  - “오늘”은 서버 기준 일자(또는 사용자 타임존 정책에 따름).  
  - 삭제/완료된 목표는 제외.

---

## 4. 목표 생성 처리 흐름

```
[요청] 목표 생성 (user_id, 목표 내용 등)
    ↓
1. ActiveTaskCount 계산 (당일, 활성 목표 수)
    ↓
2. 과부하 판별: ActiveTaskCount >= guide_exposure_threshold (기본 6)
    ↓
3. 과부하이면 → GoalEventLog에 guide_exposed 이벤트 기록 (user_id, payload에 active_task_count, threshold 등)
    ↓
4. 목표 생성 허용 → Goal 엔티티 저장
    ↓
5. GoalEventLog에 task_create 이벤트 기록 (goal_id = 생성된 Goal.id)
    ↓
[응답] 생성된 목표 반환 (생성 차단 없음)
```

- **도메인 규칙:** 생성은 **절대 차단하지 않음**. 과부하여도 3번에서 이벤트만 남기고 4–5 진행.

---

## 5. 패키지 구조

### 5.1 Spring Boot + JPA 기준 (참조)

```
task_soft_limit/
├── domain/
│   ├── User.java
│   ├── Goal.java
│   └── GoalEventLog.java
├── event/
│   ├── EventType.java          // enum: GUIDE_EXPOSED, TASK_CREATE, TASK_MODIFY, APP_CLOSE, TASK_COMPLETE
│   └── GoalEventLogPayload.java // payload DTO
├── repository/
│   ├── GoalRepository.java
│   └── GoalEventLogRepository.java
├── service/
│   ├── ActiveTaskCountService.java   // ActiveTaskCount 계산
│   ├── GoalEventLogService.java      // 이벤트 기록
│   └── GoalCreateService.java        // 생성 흐름 오케스트레이션
├── controller/
│   └── GoalController.java           // 목표 생성 등 API
└── config/
    └── SoftLimitSettings.java       // threshold, cap 등 설정
```

### 5.2 Python 패키지 기준 (현재 저장소 구현)

```
TaskSoftLimit/
├── docs/                          # 문제정의서, 해결방안, PRD, MVP, 설계서
├── task_soft_limit/
│   ├── __init__.py
│   ├── domain/                     # 도메인 모델 (또는 schemas)
│   │   ├── goal.py
│   │   ├── user.py
│   │   └── goal_event_log.py
│   ├── events/
│   │   ├── event_type.py
│   │   └── logging.py             # 이벤트 기록
│   ├── policy/
│   │   ├── active_task_count.py   # ActiveTaskCount 계산
│   │   └── overload.py           # 과부하 판별
│   ├── service/
│   │   └── goal_create.py        # 생성 흐름
│   ├── repository/                # (또는 기존 백엔드 repository 연동)
│   │   └── ...
│   └── settings.py               # threshold, cap 설정
├── tests/
│   └── ...
└── __init__.py
```

- **도메인 분리 규칙:** TaskSoftLimit는 목표 수 Soft 제한 및 이벤트 로깅만 담당. Goal/User 영속화는 기존 백엔드와 연동하거나, 동일 계층(Controller → Service → Repository)으로 확장.

---

## 6. 설정값 (파라미터 정책)

| 설정 키 | 기본값 | 설명 |
|---------|--------|------|
| `ACTIVE_TASK_COUNT_CAP` | 5 | 권장 활성 목표 수 상한 (가이드 문구에 사용 가능) |
| `GUIDE_EXPOSURE_THRESHOLD` | 6 | 이 값 이상이면 과부하로 판단하고 guide_exposed 기록 |

- threshold는 설정(환경 변수 또는 설정 서비스) 기반으로 관리하여 실험/운영별로 변경 가능하게 한다.

---

## 7. 참조

- [PRD](./PRD.md), [MVP](./MVP.md)
- [문제정의서](./문제정의서.md), [해결방안탐색문서](./해결방안탐색문서.md)
